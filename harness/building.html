<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Building - wgslsmith</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../././mdbook-admonish.css">
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../harness/index.html"><strong aria-hidden="true">2.</strong> Harness</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../harness/building.html" class="active"><strong aria-hidden="true">2.1.</strong> Building</a></li><li class="chapter-item expanded "><a href="../harness/usage.html"><strong aria-hidden="true">2.2.</strong> Usage</a></li><li class="chapter-item expanded "><a href="../harness/swiftshader.html"><strong aria-hidden="true">2.3.</strong> Swiftshader</a></li><li class="chapter-item expanded "><a href="../harness/test-case-reduction.html"><strong aria-hidden="true">2.4.</strong> Test case reduction</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">wgslsmith</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/wgslsmith/wgslsmith" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/wgslsmith/wgslsmith/edit/main/docs/src/harness/building.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="building-the-harness"><a class="header" href="#building-the-harness">Building the harness</a></h1>
<div class="admonition info">
<div class="admonition-title">
<p>Info</p>
</div>
<div>
<p>Building for Windows is supported by cross compiling from Linux (ideally using <a href="https://docs.microsoft.com/en-us/windows/wsl/">WSL</a>), because I prefer working in WSL. It shouldn't be too hard to build everything natively on Windows but you're on your own.</p>
</div>
</div>
<h2 id="environment-variables"><a class="header" href="#environment-variables">Environment variables</a></h2>
<p>There are a few environment variables that you need to set to get everything to build. The easiest thing would be to add them to your shell profile but I'd recommend using a tool like <a href="https://github.com/direnv/direnv">direnv</a> to manage them.</p>
<h2 id="dawn"><a class="header" href="#dawn">Dawn</a></h2>
<p>Before building the harness, you will need to grab and build a copy of <a href="https://dawn.googlesource.com/dawn">dawn</a>. You can use the helper script in <a href="https://github.com/wgslsmith/dawn-build">https://github.com/wgslsmith/dawn-build</a>.</p>
<p>There are a few things you may need to set up first:</p>
<h3 id="cmake"><a class="header" href="#cmake">CMake</a></h3>
<p>If you don't already have it:</p>
<pre><code class="language-sh">$ sudo apt install cmake
</code></pre>
<p>on Ubuntu or <a href="https://cmake.org/download/">https://cmake.org/download/</a>.</p>
<h3 id="depot_tools"><a class="header" href="#depot_tools">depot_tools</a></h3>
<p>While you can use cmake to build dawn, you still need to install depot_tools to be able to fetch dawn's dependencies. Detailed instructions for how to do that can be found <a href="https://commondatastorage.googleapis.com/chrome-infra-docs/flat/depot_tools/docs/html/depot_tools_tutorial.html#_setting_up">here</a>. The gist of it is:</p>
<pre><code class="language-sh"># Clone the depot_tools repo somewhere on your system
$ git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
# Add it to your PATH
$ export PATH=/path/to/depot_tools:$PATH
</code></pre>
<h3 id="ninja"><a class="header" href="#ninja">Ninja</a></h3>
<p>I'd recommend using the <a href="https://ninja-build.org/">ninja</a> build system generator with cmake to build dawn. You might be able to use other cmake generators, but they might not produce the right filesystem structure for the outputs which is expected by wgslsmith's build script.</p>
<p>On Ubuntu:</p>
<pre><code class="language-sh">$ sudo apt install ninja-build
</code></pre>
<p>Otherwise grab the binary from <a href="https://github.com/ninja-build/ninja/releases">https://github.com/ninja-build/ninja/releases</a> and add it your PATH.</p>
<h3 id="linux-dependencies"><a class="header" href="#linux-dependencies">Linux dependencies</a></h3>
<p>If you're building for Linux, you might need a few more dependencies. On Ubuntu, you can install the following packages:</p>
<pre><code class="language-sh">$ sudo apt install libxrandr-dev libxinerama-dev libx11-dev \
    libxcursor-dev libxi-dev libxext-dev libxcb-shm0-dev libxtst-dev \
    libx11-xcb-dev
</code></pre>
<h3 id="windows-dependencies"><a class="header" href="#windows-dependencies">Windows dependencies</a></h3>
<p>If you're targeting Windows, you need clang and llvm to cross compile for Windows' MSVC target. Dawn doesn't seem to work with mingw as of writing this.</p>
<pre><code class="language-sh">$ sudo apt install clang-12 clang-tools-12 llvm-12
</code></pre>
<p>You'll also need a copy of the Windows SDK headers and libraries. <a href="https://github.com/Jake-Shadle/xwin">xwin</a> is a super handy tool which can be used to download that on Linux. Install it from source or grab a binary from the releases, then run the following:</p>
<pre><code class="language-sh">$ xwin splat --include-debug-libs --cache-dir /path/to/sdk
</code></pre>
<p>The <code>/path/to/sdk</code> can be anywhere on your system where you'd like to download the SDK.</p>
<h3 id="do-the-build"><a class="header" href="#do-the-build">Do the build</a></h3>
<p>First, clone the <code>dawn-build</code> repo which contains dawn as a submodule as well as a helper script to run the build.</p>
<pre><code class="language-sh">$ git clone https://github.com/wgslsmith/dawn-build
$ cd dawn-build
</code></pre>
<p>If building for Windows, you need to set a few environment variables:</p>
<pre><code class="language-sh"># Instructs cmake to use our custom toolchain file for targeting MSVC
export CMAKE_TOOLCHAIN_FILE=&quot;$(pwd)/cmake/WinMsvc.cmake&quot;
# If you installed llvm on Ubuntu like above, this should be `/usr/lib/llvm-12`
export LLVM_NATIVE_TOOLCHAIN=&quot;/path/to/llvm&quot;
# This should be the path to wherever you downloaded the Windows SDK with xwin
export XWIN_CACHE=&quot;/path/to/sdk&quot;
</code></pre>
<p>Finally, run the build script:</p>
<pre><code class="language-sh">$ ./scripts/build
</code></pre>
<p>That will probably take a while to fetch dependencies and build everything. Once it's done, you should have a <code>build</code> folder in the root of the <code>dawn-build</code> repo. This should contain, among other things, a <code>gen</code> folder with some generated code files (the header files are the important bits) and a <code>lib</code> folder with a bunch of static libraries in it.</p>
<h2 id="harness"><a class="header" href="#harness">Harness</a></h2>
<p>Once you've built the dawn libraries, you can build the harness. First, there's a couple of environment variables to set:</p>
<pre><code class="language-sh">export DAWN_SRC_DIR=&quot;/path/to/dawn-build/dawn&quot;
export DAWN_BUILD_DIR=&quot;/path/to/dawn-build/build&quot;
</code></pre>
<p>If building for Windows, make sure to also set the following variables:</p>
<pre><code class="language-sh">export CARGO_TARGET_X86_64_PC_WINDOWS_MSVC_RUSTFLAGS=&quot;\
    -C linker=/path/to/llvm/bin/lld-link \
    -Lnative=/path/to/sdk/splat/crt/lib/x86_64 \
    -Lnative=/path/to/sdk/splat/sdk/lib/ucrt/x86_64 \
    -Lnative=/path/to/sdk/splat/sdk/lib/um/x86_64&quot;
export CXX_x86_64_pc_windows_msvc=&quot;/path/to/llvm/bin/clang-cl&quot;
export CXXFLAGS_x86_64_pc_windows_msvc=&quot;\
    /imsvc /path/to/sdk/splat/crt/include \
    /imsvc /path/to/sdk/splat/sdk/include/ucrt&quot;
export AR_x86_64_pc_windows_msvc=&quot;/path/to/llvm/bin/llvm-lib&quot;
</code></pre>
<p>Make sure to clone the <code>wgslsmith</code> repo with submodules:</p>
<pre><code class="language-sh">$ git clone --recursive https://github.com/wgslsmith/wgslsmith
# or in an existing repo
$ git submodule update --init --recursive
</code></pre>
<p>Then, to build for the host platform, you can run:</p>
<pre><code class="language-sh">$ cd harness
$ cargo build --release
</code></pre>
<p>If cross compiling for Windows, you need to instead set the target explicitly:</p>
<pre><code class="language-sh">$ cargo build --release --target x86_64-pc-windows-msvc
</code></pre>
<p>Alternatively, you can set the following environment variable to avoid needing to pass <code>--target &lt;target&gt;</code> explicitly on the command line:</p>
<pre><code class="language-sh">export CARGO_BUILD_TARGET=&quot;x86_64-pc-windows-msvc&quot;
</code></pre>
<p>The harness executable will be contained in <code>harness/target/release</code> (or <code>harness/target/&lt;target&gt;/release</code> when cross compiling).</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../harness/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../harness/usage.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../harness/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../harness/usage.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
